# 主从模式

* 主进程不负责具体业务的处理，而负责调度或管理工作进程，取向与稳定
* 工作进程负责具体的业务处理，因为业务的多样性、甚至需要多人完成，所以稳定性更需要关注

### IPC
* 让不同破名的进程能够相互访问资源，并进行协调工作
* 实现技术: 命名管道、匿名管道、socket、信号量、共享内存、消息队列、Domain Socket等等
* Node中使用 libuv 的管道技术进行实现
* IPC连接过程: 
    1. 父进程准备创建子进程前，先创建一个IPC通道
    2. 再实际创建子进程
    3. 通过全局变量`NODE_CHANNEL_FD`告诉子进程这个IPC的文件描述符
    4. 子进程在启动过程中，主动去连接这个IPC
* IPC 实现的是双向通信，因为其底层的实现机制为 `Domain Socket`，所以与网络中的`socket`表现类似。

### 主从模式
* 使用代理模式 实现 主从架构
    1. 主进程监听80端口，子进程监听其他不同的端口，可以实现基本的组主从架构
    2. 但客户端到主进程，主进程到子进程，都分别要占用一个文件描述符。是理想情况的双倍。
* 解决代理模式的问题
    1. 父进程接收到socket请求之后，将socket发送给工作进程，而不是与工作进程之间建立新的socket连接来转发数据
    2. socket发送给子进程后，父进程对应的服务器也会关闭
    3. Node 进程间通信，实际上只能够发送消息，不能够传递对象
    4. 能够实现tcp服务器的传递，其实只是子进程根据父进程发送来的消息类型，重新创建的Tcp服务器而已
* 共同监听端口问题
    1. Node 底层对每个监听端口设置了 `SO_REUSEADDR` 选项，使得不同进程可以就相同的网卡和端口进行监听
    2. 对于主进程通过 send 语句发送给子进程的的句柄，子进程还原出来的 tcp 服务器的文件描述符是一致的，所以监听相同的端口，不会引起异常
    3. 多个进程监听相同的端口时，文件描述符同一个时间只能够被某个进程所使用。
    4. 也就是说，面对网络请求，只有一个幸运的进程能够抢占连接进行服务(抢占式的)。
* 实现平滑重启
    1. 子进程需要监听 `uncaughtException` 事件，事件发生时利用IPC 通知父进程自己准备退出了     
    2. 父进程收到到子进程`SUICIDE`消息后，马上创建新的`worker`进程，进行补位
    3. 发出 `SUICIDE` 消息后，子进程服务器关闭(停止接收新连接)，所有已有的连接断开之后，使用`process.exit(1)`进行退出  
    4. 在子进程推出前，还需要进行日志的输出
    5. 为了保证资源的及时释放，服务器关闭设置一个超时时间，超过时长则强制进行进程退出。

* 负载均衡
    * Node.js 使用 Round Robin 进行调度
    * 其实就是轮询.官方解释是实践效率非常高

* 状态共享
    * 使用第三方存储
    * 抽离单独的通知进程，让它单独与Redis等第三方存储状态更新获取
    * 类似于 Egg.js 中的 `agent` 进程
* cluster
    1. 进程中使用`NODE_UNIQUE_ID`进行判断是否处于`master`进程
        ```js
        cluster.isWorker = ('NODE_UNIQUE_ID' in process.env)
        cluster.isMaster = (cluster.isWorker === false)
        ```

* 主从工作机制总结
    1. 所有请求先统一经过内部TCP服务器，真正监听端口的只有主进程
    2. 在内部TCP服务器处理请求的逻辑中，有负载均衡地挑选出一个worker进程，向其发送`newconn`的内部消息，并附带客户端句柄
    3. Worker 进程接收到此内部消息，根据客户端句柄使用 `net.Socket` 创建实例，执行距离业务逻辑，并且返回。



### PM2
PM2 模块是 cluster 模块的一个包装层，尽量将 cluster 模块抽象封装，让用户像是使用单进程一样部署多进程 Node 应用
* PM2 的功能
   1. 风脏 Node cluster 模块，内部自建负载均衡
   2. 支持后台运行
   3. 0 秒停机重载，代码更新时，不需要停机
   4. 具有频繁重启的检测，避免无限循环重启
* PM2 常见模块
   1. Satan.js 提供了程序的退出、杀死等方法
   2. God.js 提供了负责维护进程的正常运行，当有异常的时候能够重启。相当于主从模式中的 master 进程。



* 创建服务器 与 监听端口是不是两回事？
* 请求的 listen 与 accept 有什么不同

通过Node.js的Cluster模块源码，深入PM2原理
https://segmentfault.com/a/1190000021230376